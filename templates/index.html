<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Map Watcher</title>
    <link rel="stylesheet" href="/css/master.css">
  </head>
  <body>
    <div class="container">
      <div class="overworld">
        <img src="/images/overworld.jpg" alt="">
      </div>
    </div>
  </body>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
  <script src="/js/constants.js" charset="utf-8"></script>
  <script type="text/javascript" charset="utf-8">
      var socket = io.connect('http://' + document.domain + ':' + location.port);

      // Connect to the SocketIO server and ask for the players
      socket.on('connect', function() {
          socket.emit('getMap');
      });

      // Clean up map on disconnect
      socket.on("disconnect", function () {
        $(".playerBox").remove();
      })

      // Place all player dots onto map
      socket.on("sendMap", function (Players) {
          jQuery.each(Players, function (i, val) {
            playerBox = $("<div></div>")
            playerBox.attr('id', i)
            playerBox.attr('class', 'playerBox')
            playerBox.css('top', (LOCATIONS[this['Location']][0]-20)+'px')
            playerBox.css('left', (LOCATIONS[this['Location']][1]-90)+'px')

              playerName = $("<span>"+this["Username"]+"</span>")
              playerName.attr('class', 'playerName')

              playerDot = $("<div></div>")
              playerDot.attr('class', "dot")
              playerDot.css('background-color', this['Colour'])


            playerBox.append(playerName)
            playerBox.append(playerDot)
            $('.overworld').append(playerBox)
          })
      });

      // Add dot to map when a socket connects
      socket.on("socketConnected", function (data) {
        playerBox = $("<div></div>")
        playerBox.attr('id', data['id'])
        playerBox.attr('class', 'playerBox')
        playerBox.css('top', (LOCATIONS[data['location']][0]-20)+'px')
        playerBox.css('left', (LOCATIONS[data['location']][1]-90)+'px')

          playerName = $("<span>"+data["username"]+"</span>")
          playerName.attr('class', 'playerName')

          playerDot = $("<div></div>")
          playerDot.attr('class', "dot")
          playerDot.css('background-color', data['colour'])


        playerBox.append(playerName)
        playerBox.append(playerDot)
        $('.overworld').append(playerBox)
      });

      // Move the dot when a location changes
      socket.on("updateMap", function (data) {
        if (LOCATIONS[data['location']][0] != 0) {
          $('#' + data['id']).animate({
            'top': (LOCATIONS[data['location']][0]-20)+'px',
            'left': (LOCATIONS[data['location']][1]-90)+'px'
          }, 1500);
        }
      });

      // Remove the dot when socket disconnects
      socket.on("socketDisconnected", function (data) {
        $("#" + data['id']).remove();
      });

  </script>
</html>
